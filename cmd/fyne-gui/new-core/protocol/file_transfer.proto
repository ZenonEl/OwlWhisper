// Путь: cmd/fyne-gui/new-core/protocol/file_transfer.proto

syntax = "proto3";

package protocol;

option go_package = "./";


// ---------------------------------------------------------------- //
// --- СООБЩЕНИЯ ДЛЯ УПРАВЛЕНИЯ И ПЕРЕДАЧИ ФАЙЛОВ --- //
// ---------------------------------------------------------------- //


// FileControl - это обертка для всех "управляющих" сообщений,
// которые передаются по основному чат-каналу для координации
// файловой передачи.
message FileControl {
    oneof payload {
        FileDownloadRequest request = 1; // Запрос на начало скачивания
        FileTransferStatus status = 2;   // Сообщение о статусе (ошибка, отмена)
        FileSeederUpdate seeder_update = 3; // Уведомление о появлении нового "сида"
    }
}


// FileDownloadRequest - запрос на начало скачивания.
message FileDownloadRequest {
  string transfer_id = 1; // ID передачи, которую нужно начать
  int64  start_offset = 2; // С какого байта начать (для докачки)
}


// FileData - "Кусок" файла. Это сообщение передается по
// отдельному, высокопроизводительному файловому стриму.
message FileData {
    string transfer_id = 1;  // ID передачи, к которой относится этот кусок
    bytes  chunk_data = 2;   // Сами байты "куска" файла
    int64  offset = 3;       // Смещение этого "куска" от начала файла
    bool   is_last_chunk = 4;  // Флаг, что это последний "кусок"
}


// FileTransferStatus - сообщение о статусе передачи.
message FileTransferStatus {
    string transfer_id = 1;
    
    enum Status {
        UNAVAILABLE = 0;      // Файл больше не доступен у отправителя
        HASH_MISMATCH = 1;    // Хеш не совпал после скачивания
        CANCELLED_BY_SENDER = 2; // Передача отменена отправителем
        CANCELLED_BY_RECEIVER = 3; // Передача отменена получателем
        GENERIC_ERROR = 4;    // Общая ошибка
    }
    Status status = 2;
    string error_message = 3;
}


// FileSeederUpdate - сообщение для реализации "торрент-файлов".
// Отправляется в группу, когда кто-то успешно скачал файл.
message FileSeederUpdate {
    string transfer_id = 1;
    // PeerID нового "сида" будет взят из `sender_id` в `SecureEnvelope`
}