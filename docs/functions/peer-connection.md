# üîó **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–∏—Ä–∞–º**

**–§–∞–π–ª:** `docs/functions/peer-connection.md`  
**–í–µ—Ä—Å–∏—è:** v1.5  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 28 –∞–≤–≥—É—Å—Ç–∞ 2025

## üéØ **–û–±–∑–æ—Ä**

–§—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–∏—Ä–∞–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –ø–∏—Ä–∞–º–∏. –í–∫–ª—é—á–∞—é—Ç –≤ —Å–µ–±—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ relay, hole punching –∏ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã.

## üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**

### **1. Connect**
```c
int Connect(char* peerID, char* addrs);
```

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ø–∏—Ä—É –ø–æ Peer ID –∏ –∞–¥—Ä–µ—Å–∞–º.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `peerID` - Peer ID –ø–∏—Ä–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `addrs` - JSON –º–∞—Å—Å–∏–≤ –∞–¥—Ä–µ—Å–æ–≤ –ø–∏—Ä–∞

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `0` - —É—Å–ø–µ—Ö
- `-1` - –æ—à–∏–±–∫–∞

**–§–æ—Ä–º–∞—Ç –∞–¥—Ä–µ—Å–æ–≤:**
```json
[
  "/ip4/192.168.1.100/tcp/1234",
  "/ip4/10.0.0.1/tcp/5678",
  "/dns4/relay.example.com/tcp/443/wss/p2p/12D3KooW..."
]
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```c
char* addrs = "[\"/ip4/192.168.1.100/tcp/1234\"]";
int result = Connect("12D3KooW...", addrs);
if (result == 0) {
    printf("‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –ø–∏—Ä—É\n");
} else {
    printf("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n");
}
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞** - –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –ª–∏ —É–∂–µ
2. **–ü–∞—Ä—Å–∏–Ω–≥** –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ JSON
3. **–°–æ–∑–¥–∞–Ω–∏–µ** AddrInfo —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
4. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ libp2p
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π** fallback —á–µ—Ä–µ–∑ relay

---

### **2. SetupAutoRelayWithDHT**
```c
int SetupAutoRelayWithDHT();
```

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ relay —á–µ—Ä–µ–∑ DHT routing table.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** –ù–µ—Ç

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `0` - —É—Å–ø–µ—Ö
- `-1` - –æ—à–∏–±–∫–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```c
int result = SetupAutoRelayWithDHT();
if (result == 0) {
    printf("‚úÖ AutoRelay —Å DHT –Ω–∞—Å—Ç—Ä–æ–µ–Ω\n");
} else {
    printf("‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AutoRelay\n");
}
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ** DHT –∏–∑ discovery manager
2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞** peer source –∏–∑ routing table
3. **–í–∫–ª—é—á–µ–Ω–∏–µ** EnableAutoRelayWithPeerSource
4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** boot delay –∏ max candidates

---

### **3. ConnectToPeer (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è)**
```c
int ConnectToPeer(char* peerID);
```

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ø–∏—Ä—É –ø–æ Peer ID (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç FindPeer –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤).

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `peerID` - Peer ID –ø–∏—Ä–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `0` - —É—Å–ø–µ—Ö
- `-1` - –æ—à–∏–±–∫–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```c
int result = ConnectToPeer("12D3KooW...");
if (result == 0) {
    printf("‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –ø–∏—Ä—É\n");
} else {
    printf("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n");
}
```

## üîÑ **–õ–æ–≥–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**

### **–≠—Ç–∞–ø—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
1. **–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤** - —á–µ—Ä–µ–∑ DHT –∏–ª–∏ –∫—ç—à
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** - –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –ª–∏ —É–∂–µ
3. **–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** - —á–µ—Ä–µ–∑ hole punching
4. **Fallback —á–µ—Ä–µ–∑ relay** - –µ—Å–ª–∏ –ø—Ä—è–º–æ–µ –Ω–µ —É–¥–∞–µ—Ç—Å—è
5. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** - —Å–æ–∑–¥–∞–Ω–∏–µ network.Conn

### **NAT Traversal:**
- **Hole Punching** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥ NAT
- **AutoNATv2** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ NAT
- **Relay** - fallback –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö NAT
- **AutoRelay** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ relay

## ‚ö° **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**

### **Connect() vs ConnectToPeer():**
- **Connect()** - –±–æ–ª–µ–µ –≥–∏–±–∫–∏–π, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞–¥—Ä–µ—Å–∞
- **ConnectToPeer()** - –ø—Ä–æ—â–µ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- **–û–±–∞** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback

### **SetupAutoRelayWithDHT():**
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π DHT –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π** peer source –∏–∑ routing table
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Ç–∏

## üö® **–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è**

### **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é:**
- **Connect()** –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
- **ConnectToPeer()** –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
- –°—Ç—Ä–æ–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **Connect()** –±—ã—Å—Ç—Ä–µ–µ (–∞–¥—Ä–µ—Å–∞ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã)
- **ConnectToPeer()** –º–µ–¥–ª–µ–Ω–Ω–µ–µ (–Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å –∞–¥—Ä–µ—Å–∞)
- **SetupAutoRelayWithDHT()** –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### **–°–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫:**
- **Hole punching** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫
- **Relay** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ relay
- **DHT lookup** - —Ç–æ–ª—å–∫–æ –¥–ª—è ConnectToPeer()

## üîß **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏**

### **Discovery:**
- **FindPeersOnce()** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–¥—Ä–µ—Å–∞ –¥–ª—è Connect()
- **StartAggressiveDiscovery()** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Connect()
- **FindProvidersForContent()** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–¥—Ä–µ—Å–∞ –¥–ª—è Connect()

### **–°–æ–±—ã—Ç–∏—è:**
- **PeerConnected** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- **PeerDisconnected** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **GetNextEvent()** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- **SavePeerToCache()** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **LoadPeerFromCache()** –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞
- **Connect()** –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞

## üìä **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

### **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–∞–π–¥–µ–Ω–Ω–æ–º—É –ø–∏—Ä—É:**
```c
// –ò—â–µ–º –ø–∏—Ä–∞
char* providers = FindProvidersForContent("content-id");
if (providers != NULL) {
    // –ü–∞—Ä—Å–∏–º JSON –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
    // ... –ø–∞—Ä—Å–∏–Ω–≥ JSON ...
    int result = Connect(peerID, addrs);
    if (result == 0) {
        printf("‚úÖ –ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ %s\n", peerID);
    }
    FreeString(providers);
}
```

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ AutoRelay –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**
```c
// –ó–∞–ø—É—Å–∫–∞–µ–º Core
StartOwlWhisper();

// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º AutoRelay
SetupAutoRelayWithDHT();

// –¢–µ–ø–µ—Ä—å –≤—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å relay –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
```

### **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```c
// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º AutoRelay
SetupAutoRelayWithDHT();

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫
StartAggressiveDiscovery("rendezvous");

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
while (1) {
    char* event = GetNextEvent();
    if (event != NULL) {
        if (strstr(event, "PeerConnected") != NULL) {
            printf("üü¢ –ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!\n");
        }
        FreeString(event);
    }
    sleep(1);
}
```

## üéØ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Connect()** –∫–æ–≥–¥–∞ –∞–¥—Ä–µ—Å–∞ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ConnectToPeer()** –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤
3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SetupAutoRelayWithDHT()** –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Å–æ–±—ã—Ç–∏—è** —á–µ—Ä–µ–∑ GetNextEvent()
5. **–ö—ç—à–∏—Ä—É–π—Ç–µ —É—Å–ø–µ—à–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üîç **–û—Ç–ª–∞–¥–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
```c
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
char* status = GetConnectionStatus();
if (status != NULL) {
    printf("–°—Ç–∞—Ç—É—Å: %s\n", status);
    FreeString(status);
}
```

### **–ö–∞—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:**
```c
// –ü–æ–ª—É—á–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
char* quality = GetConnectionQuality("peer-id");
if (quality != NULL) {
    printf("–ö–∞—á–µ—Å—Ç–≤–æ: %s\n", quality);
    FreeString(quality);
}
```

### **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏:**
```c
// –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Ç–∏
char* stats = GetNetworkStats();
if (stats != NULL) {
    printf("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: %s\n", stats);
    FreeString(stats);
}
```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 28 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–ê–≤—Ç–æ—Ä:** Core Development Team
