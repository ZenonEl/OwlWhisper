# Руководство по диагностике и решению сетевых проблем

P2P-сети — это сложно. Ваше приложение может идеально работать на вашем компьютере, но столкнуться с проблемами в другой сети. Это нормально. Сетевое окружение каждого пользователя уникально и непредсказуемо.

Это руководство — результат реальной, многодневной отладки сложнейших сетевых проблем. Оно построено по принципу "от простого к сложному" и поможет вам шаг за шагом найти и устранить корень любой проблемы с подключением.

### Золотое правило: Изолируйте проблему

Прежде чем что-то менять, задайте себе главный вопрос: **"Проблема на стороне "Искателя" (Dialer) или "Слушателя" (Listener)?"** Попробуйте поменять их роли. Если соединение устанавливается только в одну сторону (например, A -> B, но не B -> A), вы столкнулись с **асимметричным NAT**, и проблема, скорее всего, на стороне того, к кому не могут подключиться.

---

### Уровень 1: Проблемы в локальной сети (в пределах вашего Wi-Fi)

Это базовые проверки, которые решают 50% всех проблем.

#### 1.1. Не работает даже `ping` между компьютерами

*   **Симптом:** Вы не можете пропинговать один компьютер с другого по их локальным IP (`ping 192.168.1.5`).
*   **Причина:** На вашем роутере включена функция **"Изоляция клиентов" (AP Isolation)**. Она запрещает устройствам в одной Wi-Fi сети общаться друг с другом.
*   **Диагностика:** `ping <локальный_IP_другого_компьютера>`. Если пинг не проходит (100% потерь), это ваш случай.
*   **Решение:** Зайдите в веб-интерфейс роутера, найдите в настройках Wi-Fi/Безопасности опцию "Изоляция клиентов" (или "AP Isolation", "Guest Mode") и **отключите** ее.

#### 1.2. Пинг работает, но приложение не соединяется

*   **Симптом:** Пинг проходит, но соединение в приложении отваливается по таймауту. Не работает даже подключение к публичным Relay-серверам.
*   **Причина:** **Локальный файрвол** на одном из компьютеров (UFW, firewalld) блокирует **исходящие** соединения для вашего приложения.
*   **Диагностика:** Временно отключите файрвол (`sudo ufw disable`) и попробуйте снова. Если заработало — вы нашли причину.
*   **Решение:** Не оставляйте файрвол выключенным! Настройте его правильно, разрешив все исходящие соединения (это безопасно):
    ```bash
    sudo ufw default deny incoming
    sudo ufw default allow outgoing
    sudo ufw enable
    ```

#### 1.3. Проблемы начались после установки VPN (Tailscale, NordVPN и т.д.)

*   **Симптом:** Перестал работать доступ к локальным устройствам (роутеру, другому ПК).
*   **Причина:** VPN-клиент перехватывает **весь** трафик, включая локальный, и пытается отправить его в туннель.
*   **Диагностика:** Временно отключите VPN-клиент (`sudo tailscale down`). Если доступ появился, проблема в нем.
*   **Решение (для Tailscale):** Запустите его с опцией, не перехватывающей DNS, и разрешите доступ к локальной сети.
    ```bash
    # Эта команда решает большинство проблем
    sudo tailscale up --accept-dns=false
    ```

---

### Уровень 2: Продвинутые и "невидимые" проблемы

Если база в порядке, но UDP-соединения (QUIC, WebRTC) нестабильны, копаем глубже.

#### 2.1. Соединение устанавливается, но стрим отваливается (`connection failed`)

*   **Симптом:** Успешный `ping` любого размера, но сложные протоколы не работают. Соединение вроде бы есть, но рукопожатие не проходит.
*   **Причина:** **Аппаратное ускорение (Hardware Offloading)** на сетевой карте работает некорректно и **незаметно повреждает** сложные UDP-пакеты. Чаще всего виноват **Generic Receive Offload (GRO)**.
*   **Диагностика:** Проверьте, включена ли опция:
    ```bash
    # Замените enp5s0 на имя вашего интерфейса (ip addr)
    sudo ethtool -k enp5s0 | grep generic-receive-offload
    ```
*   **Решение:** Временно отключите GRO для теста. Если поможет, сделайте это постоянным.
    ```bash
    # Временное отключение
    sudo ethtool -K enp5s0 gro off
    ```
    Чтобы сделать настройку постоянной, создайте `systemd service`, который будет выполнять эту команду при каждой загрузке системы.

#### 2.2. Ошибка `tls: bad certificate`

*   **Симптом:** Соединение обрывается с ошибкой, связанной с сертификатом или криптографией.
*   **Причина:** Вы пытаетесь подключиться к "процессу-зомби". Старый экземпляр вашего приложения не был полностью остановлен и продолжает занимать порты, но его криптографические ключи уже не соответствуют новому запуску.
*   **Диагностика:** `ps aux | grep "[g]o run"` (квадратные скобки помогают отфильтровать сам `grep`).
*   **Решение:** Принудительно завершите все старые процессы вашего приложения на **обоих** компьютерах перед новым запуском: `kill -9 <PID>`.

---

### Уровень 3: "Финальный босс" — Мобильный интернет (CG-NAT)

Это самое враждебное окружение для P2P. Прямое соединение здесь почти невозможно, вся надежда на Relay.

#### 3.1. Узел на мобильном интернете не может подключиться даже к bootstrap-узлам

*   **Симптом:** Приложение не может найти ни одного пира, в логах ошибки подключения к bootstrap-серверам.
*   **Причина:** **DNS-сервер мобильного оператора** блокирует или не может разрешить адреса bootstrap-узлов.
*   **Диагностика:** На устройстве с мобильным интернетом выполните: `ping bootstrap.libp2p.io`. Если вы видите ошибку "Неизвестное имя или служба", проблема в DNS.
*   **Решение:** Вручную измените DNS-сервер в настройках мобильного подключения на публичный (например, `1.1.1.1` от Cloudflare или `8.8.8.8` от Google).

#### 3.2. Соединение ПК -> Телефон (моб. интернет) не работает

*   **Симптом:** Телефон может подключиться к ПК, но ПК к телефону — нет. Логи на ПК показывают, что он находит только бесполезный публичный IP оператора.
*   **Причина:** **Асимметричный NAT** и сбой механизма `AutoNAT`. Узел на телефоне не понимает, что он находится за непробиваемой стеной, и поэтому **не активирует AutoRelay** и не анонсирует свой рабочий Relay-адрес.
*   **Решение:** Принудительно перевести узел в "приватный" режим. Это заставит его немедленно активировать AutoRelay. Добавьте эту опцию в конфигурацию `libp2p.New`:
    ```go
    libp2p.ForceReachabilityPrivate(),
    ```

#### 3.3. Соединение через Relay устанавливается, но стрим отваливается по таймауту

*   **Симптом:** Логи показывают `✅ УСПЕШНОЕ СОЕДИНЕНИЕ`, но сразу за ним `❌ Не удалось открыть стрим: context deadline exceeded`.
*   **Причина:** Качество соединения через `Relay + CG-NAT` очень низкое (высокая задержка, потеря пакетов). Стандартного 10-секундного таймаута не хватает для завершения криптографического рукопожатия.
*   **Решение:** Увеличьте таймаут для операции создания стрима в коде:
    ```go
    streamCtx, streamCancel := context.WithTimeout(ctx, 30*time.Second) // Ждем 30 секунд
    stream, err := node.NewStream(streamCtx, p.ID, protocolID)
    streamCancel()
    ```

---

### Уровень 4: Особенности мобильных платформ (Android)

*   **Симптом:** Соединение нестабильно, рвется, когда телефон гасит экран или приложение свернуто.
*   **Причина:** **Агрессивная оптимизация батареи** в Android. ОС "душит" и "убивает" фоновые процессы, особенно если они активно используют сеть. Termux особенно уязвим для этого.
*   **Решение:** Для создания по-настоящему стабильного мобильного клиента необходимо упаковывать приложение в **нативный APK** и использовать:
    1.  **Foreground Service:** Чтобы сказать Android, что ваше приложение выполняет важную фоновую работу и его нельзя "убивать".
    2.  **Wake Locks и отключение оптимизации батареи:** Чтобы предотвратить "засыпание" сети во время активного соединения.

Надеемся, это руководство поможет вам в вашем P2P-путешествии